name: Build and publish lol-skins manifest (v2)

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *"

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Prepare environment
        run: |
          sudo apt-get update
          sudo apt-get install -y jq coreutils git curl
      
      - name: Configure git user
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
      
      - name: Clone this repository (app)
        run: |
          git clone --depth=1 "https://github.com/${{ github.repository }}.git" app
          mkdir -p app/tmp
      
      - name: Fetch external releases info (always)
        id: fetch_releases
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          TMP_RELEASES="app/tmp/external_releases.json"
          REPO="LeagueToolkit/cslol-manager"
          
          echo "Fetching latest release for $REPO..."
          RELEASE_JSON=$(gh release view --repo "$REPO" --json tagName,assets)
          
          TAG_NAME=$(echo "$RELEASE_JSON" | jq -r '.tagName')
          ASSET=$(echo "$RELEASE_JSON" | jq -r '.assets[] | select(.name | endswith(".zip")) | select(.name | contains("cslol-manager")) | .')
          
          if [ -z "$ASSET" ] || [ "$ASSET" = "null" ]; then
            echo "Error: Could not find cslol-manager zip asset"
            exit 1
          fi
          
          ASSET_NAME=$(echo "$ASSET" | jq -r '.name')
          DOWNLOAD_URL=$(echo "$ASSET" | jq -r '.url')
          SIZE=$(echo "$ASSET" | jq -r '.size')
          
          jq -n --arg repo "$REPO" \
                --arg tag "$TAG_NAME" \
                --arg name "$ASSET_NAME" \
                --arg url "$DOWNLOAD_URL" \
                --argjson size "$SIZE" \
                '[{
                  "repo": $repo,
                  "tag_name": $tag,
                  "asset_name": $name,
                  "browser_download_url": $url,
                  "size": $size
                }]' > "$TMP_RELEASES"
          
          echo "External releases saved to $TMP_RELEASES"
      
      - name: Clone lol-skins repository
        run: |
          git clone --depth=1 "https://github.com/darkseal-org/lol-skins.git" lol-skins
      
      - name: Build manifest v2
        run: |
          set -euo pipefail
          cd lol-skins
          
          MANIFEST="manifest.json"
          REPO_URL="https://github.com/darkseal-org/lol-skins"
          BRANCH="main"
          COMMIT=$(git rev-parse HEAD)
          GENERATED_AT=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          
          echo "Building manifest v2..."
          echo "Commit: $COMMIT"
          echo "Generated: $GENERATED_AT"
          
          # Start JSON structure
          jq -n \
            --argjson schema 2 \
            --arg generated "$GENERATED_AT" \
            --arg source_repo "${REPO_URL}@${COMMIT}" \
            --arg branch "$BRANCH" \
            --arg license "MIT" \
            --arg source "$REPO_URL" \
            --arg attribution "League of Legends skins from darkseal-org/lol-skins" \
            '{
              schema: $schema,
              generated_at: $generated,
              source_repo: $source_repo,
              branch: $branch,
              license: $license,
              source: $source,
              attribution: $attribution,
              champions: []
            }' > "$MANIFEST"
          
          # Process each champion
          for CHAMP_DIR in skins/*/; do
            [ -d "$CHAMP_DIR" ] || continue
            
            CHAMP_NAME=$(basename "$CHAMP_DIR")
            CHAMP_KEY=$(echo "$CHAMP_NAME" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9]//g')
            
            echo "Processing champion: $CHAMP_NAME (key: $CHAMP_KEY)"
            
            # Build skins array
            SKINS_JSON="[]"
            for SKIN_FILE in "$CHAMP_DIR"*.zip; do
              [ -f "$SKIN_FILE" ] || continue
              
              SKIN_NAME=$(basename "$SKIN_FILE" .zip)
              SKIN_KEY=$(echo "$SKIN_NAME" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9]//g')
              SKIN_SIZE=$(stat -c%s "$SKIN_FILE")
              SKIN_HASH=$(sha256sum "$SKIN_FILE" | cut -d' ' -f1)
              SKIN_PATH="skins/${CHAMP_NAME}/${SKIN_NAME}.zip"
              SKIN_URL="https://raw.githubusercontent.com/darkseal-org/lol-skins/main/${SKIN_PATH}"
              
              SKINS_JSON=$(echo "$SKINS_JSON" | jq \
                --arg key "$SKIN_KEY" \
                --arg name "$SKIN_NAME" \
                --arg url "$SKIN_URL" \
                --argjson size "$SKIN_SIZE" \
                --arg sha256 "$SKIN_HASH" \
                --arg commit "$COMMIT" \
                '. += [{
                  key: $key,
                  name: $name,
                  url: $url,
                  size: $size,
                  sha256: $sha256,
                  commit: $commit
                }]')
            done
            
            # Build chromas array
            CHROMAS_JSON="[]"
            if [ -d "$CHAMP_DIR/chromas" ]; then
              for CHROMA_FILE in "$CHAMP_DIR/chromas/"*.zip; do
                [ -f "$CHROMA_FILE" ] || continue
                
                CHROMA_NAME=$(basename "$CHROMA_FILE" .zip)
                CHROMA_KEY=$(echo "$CHROMA_NAME" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9]//g')
                CHROMA_SIZE=$(stat -c%s "$CHROMA_FILE")
                CHROMA_HASH=$(sha256sum "$CHROMA_FILE" | cut -d' ' -f1)
                CHROMA_PATH="skins/${CHAMP_NAME}/chromas/${CHROMA_NAME}.zip"
                CHROMA_URL="https://raw.githubusercontent.com/darkseal-org/lol-skins/main/${CHROMA_PATH}"
                
                CHROMAS_JSON=$(echo "$CHROMAS_JSON" | jq \
                  --arg key "$CHROMA_KEY" \
                  --arg name "$CHROMA_NAME" \
                  --arg url "$CHROMA_URL" \
                  --argjson size "$CHROMA_SIZE" \
                  --arg sha256 "$CHROMA_HASH" \
                  --arg commit "$COMMIT" \
                  '. += [{
                    key: $key,
                    name: $name,
                    url: $url,
                    size: $size,
                    sha256: $sha256,
                    commit: $commit
                  }]')
              done
            fi
            
            # Calculate total size and fingerprint for champion
            TOTAL_SIZE=$(echo "$SKINS_JSON" "$CHROMAS_JSON" | jq -s 'add | add | [.[]? | .size] | add // 0')
            FINGERPRINT=$(echo "$SKINS_JSON" "$CHROMAS_JSON" | jq -s -r 'add | add | [.[]? | .sha256] | sort | join("|") | @base64')
            
            # Add champion to manifest
            TEMP_MANIFEST=$(mktemp)
            jq \
              --arg key "$CHAMP_KEY" \
              --arg name "$CHAMP_NAME" \
              --argjson skins "$SKINS_JSON" \
              --argjson chromas "$CHROMAS_JSON" \
              --argjson size "$TOTAL_SIZE" \
              --arg fingerprint "$FINGERPRINT" \
              '.champions += [{
                key: $key,
                name: $name,
                fingerprint: $fingerprint,
                size: $size,
                assets: {
                  skins: $skins,
                  chromas: $chromas
                }
              }]' "$MANIFEST" > "$TEMP_MANIFEST"
            mv "$TEMP_MANIFEST" "$MANIFEST"
          done
          
          # Merge external releases
          if [ -f "../app/tmp/external_releases.json" ]; then
            echo "Merging external releases..."
            EXTERNAL_RELEASES=$(cat "../app/tmp/external_releases.json")
            TEMP_MANIFEST=$(mktemp)
            jq --argjson releases "$EXTERNAL_RELEASES" \
              '.external_releases = $releases' "$MANIFEST" > "$TEMP_MANIFEST"
            mv "$TEMP_MANIFEST" "$MANIFEST"
          fi
          
          echo "Manifest v2 build complete!"
          echo "Total champions: $(jq '.champions | length' "$MANIFEST")"
          
          # Move to app output
          mkdir -p ../app/public
          cp "$MANIFEST" ../app/public/manifest.json
      
      - name: Commit and push manifest
        run: |
          cd app
          git add public/manifest.json
          
          if git diff --staged --quiet; then
            echo "No changes to manifest"
            exit 0
          fi
          
          git commit -m "chore: update lol-skins manifest v2 [skip ci]"
          git push origin HEAD:gh-pages || {
            echo "Creating gh-pages branch..."
            git checkout -b gh-pages
            git push origin gh-pages
          }
